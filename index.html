<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Chatterix</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBXzlr0Saqbv2Hk176EeGAuLTk6P1jUVdM",
      authDomain: "chatterix-123.firebaseapp.com",
      databaseURL: "https://chatterix-123-default-rtdb.firebaseio.com",
      projectId: "chatterix-123",
      storageBucket: "chatterix-123.appspot.com",
      messagingSenderId: "877024977371",
      appId: "1:877024977371:web:eab1bec6d6ed166181c7fe",
      measurementId: "G-QK732VPPG3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentUser = localStorage.getItem("currentUser");
    if (!currentUser) {
      currentUser = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫:");
      if (!currentUser || currentUser.trim() === "") {
        alert("–ù–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!");
        location.reload();
      }
      localStorage.setItem("currentUser", currentUser);
    }

    const userRef = ref(db, "users/" + currentUser);
    set(userRef, { name: currentUser, online: true });

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("userDisplay").innerText = currentUser;

      const friendsRef = ref(db, "friends/" + currentUser);
      onValue(friendsRef, (snapshot) => {
        const list = document.getElementById("friendsList");
        list.innerHTML = "";
        const data = snapshot.val();
        if (data) {
          Object.keys(data).forEach(friend => {
            const li = document.createElement("li");
            li.textContent = friend;
            li.onclick = () => openPrivateChat(friend);
            list.appendChild(li);
          });
        }
      });

      document.getElementById("addFriendBtn").onclick = () => {
        const friendName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –¥—Ä—É–≥–∞:");
        if (friendName && friendName !== currentUser) {
          const newFriendRef = ref(db, "friends/" + currentUser + "/" + friendName);
          set(newFriendRef, true);
        }
      };
    });

    function openPrivateChat(friend) {
      document.getElementById("chatBox").innerHTML = "";
      const chatKey = currentUser < friend ? `${currentUser}_${friend}` : `${friend}_${currentUser}`;
      const chatRef = ref(db, "private_chats/" + chatKey);

      onValue(chatRef, (snapshot) => {
        const data = snapshot.val();
        const box = document.getElementById("chatBox");
        box.innerHTML = "";
        if (data) {
          Object.values(data).forEach(msg => {
            const p = document.createElement("p");
            p.textContent = msg.sender + ": " + msg.text;
            box.appendChild(p);
          });
        }
      });

      document.getElementById("sendBtn").onclick = () => {
        const msgInput = document.getElementById("msgInput");
        const msg = msgInput.value;
        if (msg.trim() === "") return;

        const newMsgRef = push(chatRef);
        set(newMsgRef, {
          sender: currentUser,
          text: msg
        });
        msgInput.value = "";
      };
    }
  </script>
  <style>
    body {
      font-family: sans-serif;
      margin: 30px;
      background: #1e1e1e;
      color: white;
    }
    input, button {
      padding: 6px;
      font-size: 14px;
    }
    #chatBox {
      border: 1px solid #555;
      height: 200px;
      overflow-y: auto;
      background: #2c2c2c;
      padding: 5px;
      margin-bottom: 10px;
    }
    #friendsList li {
      cursor: pointer;
      margin: 5px 0;
    }
    #friendsList li:hover {
      color: lightgreen;
    }
  </style>
</head>
<body>
  <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="userDisplay"></span>!</h1>

  <button id="addFriendBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</button>
  <h3>üë• –î—Ä—É–∑—å—è:</h3>
  <ul id="friendsList"></ul>

  <hr>

  <div>
    <h3>üí¨ –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç:</h3>
    <div id="chatBox"></div>
    <input type="text" id="msgInput" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</body>
</html>
